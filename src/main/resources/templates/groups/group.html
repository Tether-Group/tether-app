<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Group</title>
    <th:block th:insert="~{partials/styles :: styles}"></th:block>
    <link rel="stylesheet" href="/styles/group.css"/>
</head>
<body>
<th:block th:insert="~{partials/navbar :: navbar}"></th:block>
<h1><span th:text="${group.name}"></span></h1>
<div class="group-photo-banner">

</div>


<div sec:authorize="isAuthenticated()">
    <div th:if="${isMember && !isPending}">
        <th:block th:insert="~{partials/create-post :: create-post}"></th:block>
    </div>
</div>

<div class="container">
    <!--    join group button/form-->
    <div sec:authorize="isAuthenticated()">
        <div th:if="${loggedInUser.getId() != admin.id && !isMember && !isPending}">
            <form th:action="@{/group/{groupId}/join(groupId=${group.id})}" th:method="POST">
                <button id="join-group-btn" type="submit" class="btn btn-primary">
                    Join Group
                </button>
            </form>
        </div>
    </div>
    <!--    pending button-->
    <div sec:authorize="isAuthenticated()">
        <div th:if="${loggedInUser.getId() != admin.id && !isMember && isPending}">
            <form th:action="@{/group/{groupId}/leave(groupId=${group.id})}" th:method="POST">
                <button id="pending-group-btn" type="submit" class="btn btn-warning">
                    Cancel Request
                </button>
            </form>
        </div>
    </div>
    <!--    leave group button/form-->
    <div sec:authorize="isAuthenticated()">
        <div th:if="${loggedInUser.getId() != admin.id && isMember && !isPending}">
            <form th:action="@{/group/{groupId}/leave(groupId=${group.id})}" th:method="POST">
                <button id="leave-group-btn" type="submit" class="btn btn-danger">
                    Leave Group
                </button>
            </form>
        </div>
    </div>
    <div>
        <p>The admin of this group is <span th:text="${group.admin}"></span></p>
        <h5><span th:text="${group.description}"></span></h5>
    </div>
</div>

<div sec:authorize="isAuthenticated()">
    <!--button displays on page-->
    <div th:if="${loggedInUser.id == admin.id}">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editGroupModal">
            Edit Group
        </button>
    </div>
    <div class="modal fade" id="editGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGroupModalLabel">Edit Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:method="post" th:action="@{/group/edit}" th:object="${group}">
                    <div class="modal-body">
                        <label for="group-name">Group Name:</label>
                        <input type="text" name="name" id="group-name" th:value="${group.name}" th:field="*{name}"
                               required>
                        <br>
                        <label for="description">Description:</label>
                        <input name="description" id="description" th:value="${group.description}"
                               th:field="*{description}"
                               required>
                        <br>
                        <label for="visibility">Visibility:</label>
                        <input type="checkbox" name="private" th:value="${group.private}" th:field="*{private}"
                               id="visibility">
                        <span>Private</span>
                        <br>
                        <label for="post-types">Post Types:</label>
                        <select name="postTypes" id="post-types" th:value="${group.postTypes}" th:field="*{postTypes}"
                                multiple>
                            <option value="2">Event</option>
                            <option value="3">For Sale</option>
                            <option value="4">Q&A</option>
                        </select>
                        <br>
                        <input type="hidden" th:field="*{id}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Submit Edit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div sec:authorize="isAuthenticated()">
    <div th:if="${loggedInUser.getId() == admin.id}">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteGroupModal">
            Delete Group
        </button>
    </div>
    <div class="modal fade" id="deleteGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteGroupModalLabel">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:method="post" th:action="@{/group/delete}" th:object="${group}">
                    <div class="modal-body">
                        <label for="group-name">Group Name:</label>
                        <div name="name" id="group-name-delete">Are you sure you want to delete: <span
                                th:text="${group.name}" th:field="*{name}"></span>?
                        </div>
                        <input type="hidden" th:field="*{id}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="three-main">


    <div class="group-nav">
        <h3>Group Nav</h3>
        <ul class="group-nav-list">
            <li>view all posts</li>
            <li>Text Posts</li>
            <li>Event Posts</li>
            <li>Sale Posts</li>
            <li>QandA Posts</li>
        </ul>
    </div>


    <div class="post-list list-group">
        <h3>Posts</h3>
        <div th:each="post: ${posts}">

            <div th:if="${post.postType.id == 1}">
                <th:block th:insert="~{partials/text-post :: text-post}"></th:block>
            </div>

            <div th:if="${post.postType.id == 2}">
                <th:block th:insert="~{partials/event-post :: event-post}"></th:block>
            </div>

            <div th:if="${post.postType.id == 3}">
                <th:block th:insert="~{partials/sale-post :: sale-post}"></th:block>
            </div>

            <div th:if="${post.postType.id == 4}">
                <th:block th:insert="~{partials/QandA-post :: QandA-post}"></th:block>
            </div>
            <div th:if="${loggedInUser != null}">
                <form th:if="${loggedInUser.id == admin.id && loggedInUser.id != post.user.id}" th:method="post"
                      th:action="@{/post/delete}">
                    <input th:name="id" th:value="${post.id}" hidden>
                    <input th:name="groupId" th:value="${group.id}" hidden>
                    <button type="submit" class="btn btn-danger">
                        Delete
                    </button>
                </form>
            </div>

        </div>
    </div>

    <div class="members-list">
        <h3>Members</h3>
        <div class="list-group">
            <div class="list-group-item list-group-item-action my-2">
                <div sec:authorize="isAuthenticated()">
                    <a th:href="@{/profile/{username}(username=${admin.username})}"><h1><span
                            th:text="${admin.username}"></span></h1></a>
                </div>
                <div sec:authorize="!isAuthenticated()">
                    <h1><span th:text="${admin.username}"></span></h1>
                </div>
            </div>
            <div th:each="member: ${members}" class="list-group-item list-group-item-action my-2">
                <div sec:authorize="isAuthenticated()">
                    <a th:href="@{/profile/{username}(username=${member.username})}"><h1><span
                            th:text="${member.username}"></span></h1></a>
                </div>
                <div sec:authorize="!isAuthenticated()">
                    <h1><span th:text="${member.username}"></span></h1>
                </div>
                <div sec:authorize="isAuthenticated()" th:if="${loggedInUser.id == admin.id}">
                    <form th:action="@{/group/{groupId}/{memberId}/remove(groupId=${groupId}, memberId=${member.id})}"
                          th:method="post">
                        <button type="submit" class="btn btn-danger">Remove</button>
                    </form>
                </div>
            </div>
            <div>
                <a th:href="@{/group/{groupId}/members(groupId=${group.id})}">View All Members</a>
            </div>
        </div>
    </div>

</div>

<th:block th:insert="~{partials/footer :: footer}"></th:block>
<script th:src="@{/js/posts.js}"></script>
</body>
</html>